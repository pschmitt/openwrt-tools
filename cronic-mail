#!/usr/bin/env sh

# Merged cronic and cronic-mail script
# Usage: cronic-mail CMD
# This script runs CMD, and emails the output if CMD fails or produces error output.

set -eu

usage() {
  echo "Usage: $(basename "$0") CMD" >&2
}

log() {
  echo "$*" >&2
}

resolve_mail_alias() {
  MAIL_ALIAS="$1"
  ALIAS_FILE="/etc/aliases"
  [ -z "$MAIL_ALIAS" ] && return 0
  [ ! -f "$ALIAS_FILE" ] && return 0
  awk -F ' *: *' -v al="$MAIL_ALIAS" \
    '$0 ~ "^" al " *:" { print $2; exit }' \
    "$ALIAS_FILE"
}

send_email() {
  {
    echo "Subject: Cronic detected failure in cron job: $*"
    [ -n "$MAILTO" ] && echo "To: $MAILTO"
    echo ""
    cat "$TMP_MAIL"
  } | {
    if [ -n "$DRY_RUN" ]
    then
      cat >&2 # output the email to stderr
    else
      sendmail "${MAILTO:-$USER}"
    fi
  }
}

if [ $# -eq 0 ]
then
  usage >&2
  exit 2
fi

DRY_RUN=${DRY_RUN:-}
USER=$(id -un)
MAILTO=${MAILTO:-$(resolve_mail_alias "$USER")}

TMP=$(mktemp -d)
OUT="$TMP/cronic.out"
ERR="$TMP/cronic.err"
TRACE="$TMP/cronic.trace"
TMP_MAIL="$TMP/cronic.mail"

# Execute the command
set +e
{
  "$@" >"$OUT" 2>"$TRACE"
  RC="$?"
}
set -e

# Assuming PS4 is '+', which is default in POSIX sh
PATTERN='^\+ '
if grep -Eaq "$PATTERN" "$TRACE"
then
  grep -Eav "$PATTERN" "$TRACE" > "$ERR"
else
  ERR="$TRACE"
fi

if [ "$RC" -ne 0 ] || [ -s "$ERR" ]
then
  {
    echo "Cronic detected failure or error output for the command:"
    echo "$*"
    echo

    echo "RETURN CODE: $RC"
    echo

    echo "ERROR OUTPUT:"
    cat "$ERR"
    echo

    echo "STANDARD OUTPUT:"
    cat "$OUT"
    echo

    if [ "$TRACE" != "$ERR" ]
    then
      echo "TRACE-ERROR OUTPUT:"
      cat "$TRACE"
      echo
    fi
  } > "$TMP_MAIL"

  # send mail
  send_email "$*"
fi

rm -rf "$TMP"
