#!/usr/bin/env sh

# cronic-mail - wraps cronic to send output via email when cronic outputs
# something (ie the job failed)
# Mainly intended for cron implementations that don't support sending emails on
# failure.
# Usage: cronic-mail CMD

if [ $# -eq 0 ]
then
  echo "Usage: $0 CMD" >&2
  exit 2
fi

resolve_mail_alias() {
  MAIL_ALIAS="$1"
  ALIAS_FILE=/etc/aliases
  [ -z "$MAIL_ALIAS" ] && return 0
  [ ! -f "$ALIAS_FILE" ] && return 0
  awk -F ' *: *' -v al="$MAIL_ALIAS" \
    '$0 ~ "^" al " *:" { print $2; exit }' \
    "$ALIAS_FILE"
  unset MAIL_ALIAS
}

USER=$(id -un)
MAILTO=${MAILTO:-$(resolve_mail_alias "$USER")}
TMP=$(mktemp)

# Run cronic with the provided command and capture its output
cronic "$@" > "$TMP"

# Check if cronic produced any output
if [ -s "$TMP" ]
then
  {
    echo "Subject: Cronic detected failure in cron job: $*"
    if [ -n "$MAILTO" ]
    then
      echo "To: $MAILTO"
    fi
    echo ""
    cat "$TMP"
  } | sendmail "${MAILTO:-$USER}"
fi

# Clean up the temporary file
rm -f "$TMP"

exit 0
